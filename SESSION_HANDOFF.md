# Session Handoff: mcp-cross WSL Bridge Debugging

## Objective

Fix the `mcp-cross` PATH filtering mechanism on WSL. The goal is to remove Windows paths (e.g., `/mnt/c/...`) from the PATH before executing the MCP server. This is critical because:

1. WSL interop appends Windows paths to the Linux PATH.
2. `npx` or `node` on Windows paths (e.g., `/mnt/c/Program Files/nodejs/npx`) might be found before the Linux versions.
3. Windows binaries often fail in this context or cause "C:\Program is not recognized" errors due to spaces in paths.

## Current Status

* **Current Version**: `mcp-cross@1.0.16`
* **Status**: Failing. User reports "none of them connected" with v1.0.16.
* **Environment**: Windows Host -> WSL (Ubuntu) -> Shell: `zsh`.

## Attempts & Outcomes

### Attempt 1: Shell Pipeline (v1.0.13)

* **Method**: `export PATH=$(printenv PATH | tr ':' '\n' | grep -v '^/mnt/[a-z]/' | paste -sd:)`
* **Outcome**: Failed.
* **Error**: `zsh:1: unmatched "`
* **Cause**: Nested double quotes in the command string generated by `wsl-bridge.js` caused `zsh` to parse the command incorrectly.

### Attempt 2: Perl One-Liner (v1.0.14)

* **Method**: `export PATH=$(perl -e 'print join(":", grep { !m{^/mnt/[a-z]/} } split(":", $ENV{PATH}))')`
* **Outcome**: Failed (Worse).
* **Error**: `zsh:1: no matches found: ^/mnt/[a-z]/` and `env: ‘npx’: No such file`.
* **Cause**: `zsh` tried to perform glob expansion on the regex `^/mnt/[a-z]/` before passing it to Perl. This failed, causing the command to abort or produce an empty PATH.

### Attempt 3: Perl with Escaped Env (v1.0.15)

* **Method**: `export PATH=$(perl -e '... \\$ENV{PATH} ...')` (Escaping `$ENV` to prevent shell expansion).
* **Outcome**: Partial Success / Mixed.
* **User Report**: "2/3 servers worked" (Filesystem and Ghostis succeeded after retries, GitHub server failed).
* **Theory**: The fix likely resolved the globbing issue, but the GitHub server failure suggests either:
  * The PATH was still not perfectly clean.
  * The GitHub server relies on specific environment variables that were lost or malformed.
  * Timing issues with `npx` cache.

### Attempt 4: Sed (v1.0.16)

* **Method**: `export PATH=$(echo "$PATH" | sed -E 's|/mnt/[a-z]/[^:]*:?||g')`
* **Outcome**: Failed completely ("none of them connected").
* **Theory**:
  * **Quoting**: `echo "$PATH"` inside the outer command quotes might be expanding prematurely or incorrectly in the `wsl.exe` argument parsing.
  * **Sed Syntax**: While standard, `sed -E` might behave differently depending on the exact `sed` version in the user's WSL distro, or the pipe `|` character is interacting with the outer shell invocation.

## Theories & Recommendations for Windows Debugging

### 1. The "Quoting Hell" Hypothesis

We are constructing a command string in Node.js, passing it to `child_process.spawn('wsl.exe', ...)`, which passes it to the Windows kernel, which passes it to the WSL init process, which passes it to `bash -l -c`, which might pass it to `zsh`.

* **Problem**: Every layer strips or interprets quotes.
* **Recommendation**: Instead of trying to inline the PATH filtering logic in the command string, **create a helper script** inside the package (e.g., `src/scripts/wsl-runner.sh`).
  * Copy this script to a temp location or run it directly if mapped.
  * The script handles PATH sanitization and execution.
  * This eliminates the need to escape complex logic in the JSON/CLI argument string.

### 2. Profile Loading Interference

We use `bash -l` (login shell) to ensure the user's environment (NVM, etc.) is loaded.

* **Problem**: `bash -l` sources `.bash_profile` / `.zshrc`. If these files modify PATH (e.g., `export PATH=$PATH:/some/windows/path`), they might re-introduce the bad paths *after* our filter runs if we aren't careful about order.
* **Observation**: We currently run `export PATH=...; env ...`. This sets PATH for the `env` command, but if `env` launches a shell (implicit in some `npx` flows), that shell might reset PATH.

### 3. GitHub Server Specifics

The GitHub server failed even when others worked.

* **Theory**: It might be using a specific binary name that exists in Windows but not Linux (or vice versa), or it requires `git` which might be resolving to `git.exe` if the filter fails.

## Action Plan for Windows Agent

1. **Do not publish blindly**. Use `npm link` or local paths in the `claude_desktop_config.json` to test changes instantly.
2. **Inspect the raw command**. Add logging in `wsl-bridge.js` to print the *exact* string being passed to `wsl.exe`.
3. **Test the Runner Script approach**. Move the complexity out of the CLI args and into a dedicated shell script.
